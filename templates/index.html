<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoterÃ­a</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <h2>ğŸŸï¸ LoterÃ­a de Chipaque</h2>
        <p>ğŸ’° PREMIO = 150000000</p>
        <input type="text" id="search-dic1" placeholder="Buscar por nÃºmero de boleto" onkeyup="searchTickets(1)">
        <table>
            <thead>
                <tr>
                    <th>ğŸ« Numero de Boleto</th>
                    <th>ğŸ“… Fecha de Emision</th>
                    <th>ğŸ“‹ Estado del Tiquete</th>
                </tr>
            </thead>
            <tbody id="dic1-tbody"></tbody>
        </table>
        <div id="pagination-dic1"></div>
        <button onclick="fetchWinner(1)">ğŸ† Encontrar Ganador</button>

        <h2>ğŸŸï¸ LoterÃ­a de Bucaramanga</h2>
        <p>ğŸ’° PREMIO = 150000000</p>
        <input type="text" id="search-dic2" placeholder="Buscar por nÃºmero de boleto" onkeyup="searchTickets(2)">
        <table>
            <thead>
                <tr>
                    <th>ğŸ« Numero de Boleto</th>
                    <th>ğŸ“… Fecha de Emision</th>
                    <th>ğŸ“‹ Estado del Tiquete</th>
                </tr>
            </thead>
            <tbody id="dic2-tbody"></tbody>
        </table>
        <div id="pagination-dic2"></div>
        <button onclick="fetchWinner(2)">ğŸ† Encontrar Ganador</button>

        <h2>ğŸŸï¸ LoterÃ­a de Fuenlabrada</h2>
        <p>ğŸ’° PREMIO = 150000000</p>
        <input type="text" id="search-dic3" placeholder="Buscar por nÃºmero de boleto" onkeyup="searchTickets(3)">
        <table>
            <thead>
                <tr>
                    <th>ğŸ« Numero de Boleto</th>
                    <th>ğŸ“… Fecha de Emision</th>
                    <th>ğŸ“‹ Estado del Tiquete</th>
                </tr>
            </thead>
            <tbody id="dic3-tbody"></tbody>
        </table>
        <div id="pagination-dic3"></div>
        <button onclick="fetchWinner(3)">ğŸ† Encontrar Ganador</button>

        <div id="winner-info"></div>

        <div class="button-container">
            <hr>
            <a href="{{ url_for('regenerar') }}">
                <button class="regen-btn">ğŸ”„ Regenerar Diccionarios</button>
            </a>
        </div>
    </div>
    <script>
        async function fetchTickets(dicNum, page) {
            const response = await fetch(`/tickets/${dicNum}/${page}`);
            const data = await response.json();
            const tickets = data.tickets;
            const total = data.total;
            const tbody = document.querySelector(`#dic${dicNum}-tbody`);
            tbody.innerHTML = '';

            tickets.forEach(ticket => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${ticket[0]}</td>
                    <td>${ticket[1].fecha_hora}</td>
                    <td>${ticket[1].estado === 1 ? 'âœ”ï¸ Comprado' : 'âŒ No Comprado'}</td>
                `;
                tbody.appendChild(row);
            });

            updatePaginationControls(dicNum, page, total);
        }

        async function searchTickets(dicNum) {
            const input = document.querySelector(`#search-dic${dicNum}`);
            const query = input.value;
            const response = await fetch(`/search/${dicNum}?query=${query}`);
            const data = await response.json();
            const tickets = data.tickets;
            const tbody = document.querySelector(`#dic${dicNum}-tbody`);
            tbody.innerHTML = '';

            tickets.forEach(ticket => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${ticket[0]}</td>
                    <td>${ticket[1].fecha_hora}</td>
                    <td>${ticket[1].estado === 1 ? 'âœ”ï¸ Comprado' : 'âŒ No Comprado'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updatePaginationControls(dicNum, page, total) {
            const itemsPerPage = 10;
            const totalPages = Math.ceil(total / itemsPerPage);
            const pagination = document.querySelector(`#pagination-dic${dicNum}`);
            pagination.innerHTML = '';

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Anterior';
            prevButton.addEventListener('click', () => {
                const newPage = page === 1 ? totalPages : page - 1;
                fetchTickets(dicNum, newPage);
            });
            pagination.appendChild(prevButton);

            const pageIndicator = document.createElement('span');
            pageIndicator.textContent = ` PÃ¡gina ${page} de ${totalPages} `;
            pagination.appendChild(pageIndicator);

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Siguiente';
            nextButton.addEventListener('click', () => {
                const newPage = page === totalPages ? 1 : page + 1;
                fetchTickets(dicNum, newPage);
            });
            pagination.appendChild(nextButton);
        }

        async function fetchWinner(dicNum) {
            const response = await fetch(`/ganador/${dicNum}`);
            const data = await response.json();
            const winnerInfo = document.getElementById('winner-info');
            winnerInfo.innerHTML = `
                <h2>ğŸ† Ganador del Diccionario ${dicNum}:</h2>
                <p>ğŸ« NÃºmero Ganador: ${data.winner[0]}</p>
                <p>ğŸ“… Fecha y Hora: ${data.winner[1].fecha_hora}</p>
                <p>ğŸ’° Valor del Premio: ${data.winner[1].valor_premio}</p>
                <p>ğŸ“‹ Estado: ${data.winner[1].estado === 1 ? 'âœ”ï¸ Comprado' : 'âŒ No Comprado'}</p>
                <p>${data.message}</p>
            `;
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchTickets(1, 1);
            fetchTickets(2, 1);
            fetchTickets(3, 1);
        });
    </script>
</body>
</html>